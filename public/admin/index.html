<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap Admin</title>
  </head>
  <body>
    <!-- TEK CDN (ikinci bir decap-cms.js, bundle ya da eklenti yükleme!) -->
    <script src="https://unpkg.com/decap-cms@3.1.0/dist/decap-cms.js"></script>

    <script>
      // Eski, bozuk durumları temizle (özellikle sizin önceki denemelerden kalan anahtarı)
      sessionStorage.removeItem('netlify-cms-user');
      // window.CMS_MANUAL_INIT ile config.yml’i dosyadan ve cache’siz okutacağız
      window.CMS_MANUAL_INIT = true;

      // 1) OAuth popup’tan gelen mesajı YAKALA → localStorage’a yaz → sayfayı yenile
      function handleAuthMessage(e) {
        // Callback aynı origin’den geldiği için güvenlik açısından kontrol edelim:
        if (e.origin !== window.location.origin) return;
        if (typeof e.data !== 'string') return;
        if (!e.data.startsWith('authorization:github:')) return;

        try {
          // "authorization:github:success:{...json...}" → JSON kısmını soy
          var payloadStr = e.data.replace(/^authorization:github:(success|error):/, '');
          var payload = JSON.parse(payloadStr); // { token: "...", provider: "github" }

          if (payload && payload.token) {
            // Decap’in beklediği format (Netlify CMS ile bire bir aynı)
            localStorage.setItem('netlify-cms-user', JSON.stringify({ token: payload.token }));
            localStorage.setItem('netlify-cms-provider', payload.provider || 'github');
            window.location.reload();
          }
        } catch (err) {
          console.error('OAuth bridge error:', err);
        }
      }
      window.addEventListener('message', handleAuthMessage, false);

      // 2) Decap’i **manuel** başlat (config.yml mutlaka cache’siz okunsun)
      fetch('config.yml', { cache: 'no-store' })
        .then(function (r) {
          if (!r.ok) throw new Error('config.yml HTTP ' + r.status);
          return r.text();
        })
        .then(function () {
          CMS.init({ config: { load_config_file: true } });
        })
        .catch(function (e) {
          document.body.innerHTML =
            '<pre>config.yml okunamadı veya init edilemedi:\n' + String(e) + '</pre>';
        });
    </script>
  </body>
</html>
