<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap Admin</title>
  </head>
  <body>
    <!-- Tek bir CDN — çift yükleme beyaz ekrana neden olur -->
    <script src="https://unpkg.com/decap-cms@3.0.10/dist/decap-cms.js"></script>

    <script>
      // Eski/yanlış cache’i temizle (giriş döngüsü olmasın)
      localStorage.removeItem('netlify-cms-user');

      // Decap'i manuel başlat (config.yml dosyadan okunacak, cache kapalı)
      window.CMS_MANUAL_INIT = true;
      const { initCMS: init } = window; // 3.x ile önerilen çağrı

      fetch('config.yml', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        })
        .then(() => {
          init({ config: { load_config_file: true } });
        })
        .catch(e => {
          document.body.insertAdjacentHTML(
            'beforeend',
            `<pre style="padding:1rem;color:#b00">config.yml okunamadı: ${e}</pre>`
          );
        });

      // --- Güvenli “yedek” dinleyici: popup token’ı yolladıysa biz de oturum açtıralım
      window.addEventListener('message', (ev) => {
        try {
          if (typeof ev.data !== 'string') return;
          const prefix = 'authorization:github:success:';
          if (!ev.data.startsWith(prefix)) return;
          const payload = JSON.parse(ev.data.slice(prefix.length)); // {token, provider}
          if (!payload?.token) return;

          // Decap’in beklediği anahtar/format
          localStorage.setItem(
            'netlify-cms-user',
            JSON.stringify({ token: payload.token, provider: payload.provider || 'github' })
          );
          // sayfayı yenile — Decap kullanıcıyı yakalayıp UI’ı açar
          window.location.reload();
        } catch (err) {
          console.error('Auth bridge error:', err);
        }
      }, false);
    </script>
  </body>
</html>
