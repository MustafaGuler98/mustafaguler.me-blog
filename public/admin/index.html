<script>
/**
 * Decap bazen postMessage'ı yakalasa bile localStorage yazamıyor.
 * Bu köprü, gelen "authorization:github:success:..." mesajını alıp
 * token'ı Decap'in beklediği anahtarla localStorage'a yazar ve sayfayı yeniler.
 */
(function () {
  function handleAuthMessage(e) {
    try {
      // Güvenlik: sadece kendi origin'imizden geleni kabul et
      if (e.origin !== window.location.origin) return;

      if (typeof e.data === 'string' && e.data.startsWith('authorization:github:')) {
        // Beklenen ham string: 'authorization:github:success:{"token":"...","provider":"github"}'
        var parts = e.data.split(':'); // ["authorization", "github", "success", '{"token":"..."}']
        var payload = parts.slice(3).join(':'); // JSON kısmı
        var data = JSON.parse(payload || '{}');
        if (data.token) {
          // Decap'in beklediği anahtar: netlify-cms-user
          localStorage.setItem('netlify-cms-user', JSON.stringify({ token: data.token }));
          // (Opsiyonel) provider bilgisini saklamak istersen:
          // localStorage.setItem('netlify-cms-provider', data.provider || 'github');
          // Yenile ve CMS'i token ile başlat
          window.location.reload();
        }
      }
    } catch (err) {
      console.error('Auth bridge error:', err);
    }
  }
  window.addEventListener('message', handleAuthMessage, false);
})();
</script>
