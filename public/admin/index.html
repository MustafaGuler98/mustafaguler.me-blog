<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap Admin</title>
  </head>
  <body>
    <!-- Tek CDN. Çift script beyaz ekran ve removeChild hatası üretir -->
    <script src="https://unpkg.com/decap-cms@3.1.0/dist/decap-cms.js"></script>

    <script>
      // Eski/yanlış anahtarları temizle (tam temiz başlangıç)
      ['decap-cms.user','decap-cms-user','netlify-cms-user'].forEach(k => localStorage.removeItem(k));

      // Decap'ı dosyadan okusun ve cache kullanmasın
      window.CMS_MANUAL_INIT = true;
      fetch('config.yml', { cache: 'no-store' })
        .then(r => {
          if (!r.ok) throw new Error('config.yml ' + r.status);
          return r.text();
        })
        .then(() => CMS.init({ config: { load_config_file: true } }))
        .catch(e => { document.body.innerHTML = '<pre>config.yml okunamadı: ' + e + '</pre>'; });

      // *** KRİTİK: OAuth popup mesajını biz de yakalayıp garanti altına alıyoruz ***
      // Decap kendi handler'ını da çalıştırır, ama biz token'ı iki anahtar adıyla da basıyoruz.
      function handleAuthMessage(ev) {
        try {
          // yalnızca aynı origin'den gelen mesajı kabul et
          if (ev.origin !== window.location.origin) return;

          const msg = String(ev.data || '');
          if (!msg.startsWith('authorization:github:success:')) return;

          const payload = JSON.parse(msg.replace('authorization:github:success:', ''));

          if (payload && payload.token) {
            const userObj = JSON.stringify({ token: payload.token, provider: 'github' });

            // Eski ve yeni isimlerle yaz (Decap / Netlify CMS uyumu)
            localStorage.setItem('decap-cms-user', userObj);
            localStorage.setItem('decap-cms.user', userObj);      // bazı sürümler noktalı adı da okuyor
            localStorage.setItem('netlify-cms-user', userObj);

            // provider anahtarlarını da tekilleştir
            localStorage.setItem('decap-cms-provider', 'github');
            localStorage.setItem('netlify-cms-provider', 'github');

            // temiz bir yeniden yükleme
            window.location.reload();
          }
        } catch (e) {
          console.error('Auth message parse error:', e);
        }
      }
      window.addEventListener('message', handleAuthMessage, false);
    </script>
  </body>
</html>
