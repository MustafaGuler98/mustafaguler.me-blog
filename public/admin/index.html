<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap Admin</title>
  </head>
  <body>
    <!-- TEK CDN (stabil) -->
    <script src="https://unpkg.com/decap-cms@3.0.10/dist/decap-cms.js"></script>

    <script>
      // Her iki anahtarı da temizle: karışıklığı önle
      localStorage.removeItem('decap-cms-user');
      localStorage.removeItem('netlify-cms-user');

      // OAuth callback'inden gelen mesajı dinle
      window.addEventListener('message', (ev) => {
        if (ev.origin !== window.location.origin) return;
        const raw = String(ev.data || '');
        if (!raw.startsWith('authorization:github:success:')) return;

        try {
          const payload = JSON.parse(raw.replace('authorization:github:success:', ''));
          // 3.0.x sürümü bu anahtarı okur
          localStorage.setItem('netlify-cms-user', JSON.stringify({ token: payload.token }));
          localStorage.setItem('netlify-cms-provider', 'github');
          window.location.reload();
        } catch (e) {
          console.error('AUTH payload parse error:', e);
        }
      }, false);
    </script>
  </body>
</html>
