<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex" />
    <title>Decap Admin</title>
    <!-- Tek CDN -->
    <script src="https://unpkg.com/decap-cms@3.0.10/dist/decap-cms.js"></script>
  </head>
  <body>
    <script>
      window.CMS_MANUAL_INIT = true;

      function handleAuthMessage(e) {
        if (!e || typeof e.data !== "string") return;
        if (!e.data.startsWith("authorization:github:")) return;
        try {
          const payload = JSON.parse(e.data.split(":").slice(2).join(":"));
          if (payload && payload.token) {
            localStorage.setItem("decap-cms-user", JSON.stringify({ token: payload.token }));
            localStorage.setItem("decap-cms-provider", "github");
            console.log("Decap token kaydedildi, sayfa yenileniyor…");
            location.reload();
          }
        } catch (err) {
          console.error("Auth payload parse edilemedi:", err, e.data);
        }
      }
      window.addEventListener("message", handleAuthMessage, false);

      (function waitForCMS() {
        if (window.CMS && typeof window.CMS.init === "function") {
          fetch("config.yml", { cache: "no-store" })
            .then(() => {
              CMS.init({ config: { load_config_file: true } });
              console.log("CMS init edildi.");
            })
            .catch((e) => {
              document.body.innerHTML =
                "<pre>config.yml okunamadı:\n" + (e && e.toString()) + "</pre>";
            });
        } else {
          setTimeout(waitForCMS, 50);
        }
      })();
    </script>
  </body>
</html>
