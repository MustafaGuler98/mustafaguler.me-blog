<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Decap Admin</title>
  <!-- Tek CDN – ikinci bir decap-cms.js yükleme! -->
  <script src="https://unpkg.com/decap-cms@3.1.0-beta.4/dist/decap-cms.js"></script>
</head>
<body>
<script>
  // Eski/yanlış netlify-cms anahtarlarını temizle
  localStorage.removeItem('netlify-cms-user');
  localStorage.removeItem('netlify-cms-provider');

  // Pop-up'tan gelecek cevabı YAKALA ve Decap'ın istediği anahtarlara yaz
  function handleAuthMessage(e) {
    if (e.origin !== window.location.origin) return;
    const raw = String(e.data || '');
    if (!raw.startsWith('authorization:github:')) return;

    const parts = raw.split(':');
    const status = parts[2];
    let payload = null;
    try { payload = JSON.parse(parts.slice(3).join(':')); } catch {}

    console.log('AUTH MSG →', status, payload);

    if (status === 'success' && payload && payload.token) {
      localStorage.setItem('decap-cms-user', JSON.stringify({ token: payload.token }));
      localStorage.setItem('decap-cms-provider', 'github');
      location.reload();
    } else {
      console.warn('Yetkilendirme başarısız');
    }
  }
  window.addEventListener('message', handleAuthMessage, false);

  // Decap’ı dosyadan konfig ile başlat
  window.CMS_MANUAL_INIT = true;
  fetch('config.yml', { cache: 'no-store' })
    .then(() => CMS.init({ config: { load_config_file: true } }))
    .catch((e) => document.body.insertAdjacentHTML('beforeend', '<pre>config.yml okunamadı: '+e+'</pre>'));
</script>
</body>
</html>
